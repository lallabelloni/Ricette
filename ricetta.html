<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Dettaglio Ricetta</title>
  <link rel="stylesheet" href="style-ricetta.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <a href="index.html" class="back-btn">‚Üê Torna alla lista</a>
  <div id="detailContent" class="loading">Caricamento dettagli...</div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    /* ==========================
       CONFIG SUPABASE
    ========================== */
    const supabaseUrl = 'https://uummgynzxypcscvqtihf.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bW1neW56eHlwY3NjdnF0aWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjE2ODAsImV4cCI6MjA4MjY5NzY4MH0.e0mQ1QZ2B86JsAuy24kIkt43-m6KQz_zj7oYIi8P6I8'
    const supabase = createClient(supabaseUrl, supabaseKey)
    const detailContent = document.getElementById('detailContent')
    
    /* ==========================
      HELPER: Escape HTML e preserva newlines
    ========================== */
    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }
    
    /* ==========================
      RECUPERA ID DALLA URL
    ========================== */
    function getRicettaIdFromUrl() {
      const params = new URLSearchParams(window.location.search)
      return params.get('id')
    }
    
    /* ==========================
      CARICA STAGIONI PER LA RICETTA
    ========================== */
    async function loadStagioni(ricettaId) {
      const { data, error } = await supabase
        .from('ricetta_stagioni')
        .select('stagioni(nome)')
        .eq('id_ricetta', ricettaId)
      
      if (error) {
        console.error('Errore caricamento stagioni:', error)
        return []
      }
      
      return data.map(item => item.stagioni.nome)
    }
    
    /* ==========================
      CARICA CATEGORIE PER LA RICETTA
    ========================== */
    async function loadCategorie(ricettaId) {
      const { data, error } = await supabase
        .from('ricetta_categorie')
        .select('categorie(nome)')
        .eq('id_ricetta', ricettaId)
      
      if (error) {
        console.error('Errore caricamento categorie:', error)
        return []
      }
      
      return data.map(item => item.categorie.nome)
    }
    
    /* ==========================
      CARICA INGREDIENTI CON QUANTIT√Ä
    ========================== */
    async function loadIngredienti(ricettaId) {
      const { data, error } = await supabase
        .from('ricetta_ingredienti')
        .select('quantita, ingredienti(nome)')
        .eq('id_ricetta', ricettaId)
      
      if (error) {
        console.error('Errore caricamento ingredienti:', error)
        return []
      }
      
      return data.map(item => ({
        nome: item.ingredienti.nome,
        quantita: item.quantita
      }))
    }
    
    /* ==========================
      CARICAMENTO DETTAGLIO
    ========================== */
    async function loadRicettaDetail(ricettaId) {
      if (!ricettaId) {
        detailContent.innerHTML = `
          <div class="error">
            <h2>Errore</h2>
            <p>Nessuna ricetta specificata</p>
            <a href="index.html" class="back-btn">Torna alla lista</a>
          </div>
        `
        return
      }
      
      // Carica ricetta principale
      const { data, error } = await supabase
        .from('ricetta')
        .select('*')
        .eq('id', ricettaId)
        .single()
      
      if (error) {
        console.error('Errore caricamento dettaglio:', error)
        detailContent.innerHTML = `
          <div class="error">
            <h2>Errore</h2>
            <p>Impossibile caricare i dettagli della ricetta</p>
            <a href="index.html" class="back-btn">Torna alla lista</a>
          </div>
        `
        return
      }
      
      // Carica stagioni, categorie e ingredienti in parallelo
      const [stagioni, categorie, ingredienti] = await Promise.all([
        loadStagioni(ricettaId),
        loadCategorie(ricettaId),
        loadIngredienti(ricettaId)
      ])
      
      // Render del dettaglio
      detailContent.innerHTML = `
        <div class="detail-container">
          <h1>${escapeHtml(data.nome)}</h1>
          <div class="rating-badge">‚≠ê ${Number(data.punteggio).toFixed(1)}/10</div>
          
          <div class="info-grid">
            <div class="info-item">
              <strong>Fonte</strong>
              ${escapeHtml(data.fonte || 'Non specificata')}
            </div>
            <div class="info-item">
              <strong>Costo</strong>
              ${data.costo}/5 ${'üí∞'.repeat(data.costo)}
            </div>
            <div class="info-item">
              <strong>Gusto</strong>
              ${data.gusto}/5 ${'üòã'.repeat(data.gusto)}
            </div>
            <div class="info-item">
              <strong>Sbattimento</strong>
              ${data.sbatti}/5 ${'üî®'.repeat(data.sbatti)}
            </div>
          </div>
          
          <!-- SEZIONE TAGS -->
          <div class="tags-section">
            ${stagioni.length > 0 ? `
            <div class="tag-group">
              <strong>Stagioni:</strong>
              <div class="tags-container">
                ${stagioni.map(s => `<span class="tag tag-stagione">${escapeHtml(s)}</span>`).join('')}
              </div>
            </div>
            ` : ''}
            
            ${categorie.length > 0 ? `
            <div class="tag-group">
              <strong>Categorie:</strong>
              <div class="tags-container">
                ${categorie.map(c => `<span class="tag tag-categoria">${escapeHtml(c)}</span>`).join('')}
              </div>
            </div>
            ` : ''}
            
            ${ingredienti.length > 0 ? `
            <div class="tag-group">
              <strong>Ingredienti:</strong>
              <div class="tags-container">
                ${ingredienti.map(i => `<span class="tag tag-ingrediente">${escapeHtml(i.nome)}${i.quantita ? ', ' + escapeHtml(i.quantita) : ''}</span>`).join('')}
              </div>
            </div>
            ` : ''}
          </div>
          
          ${data.descrizione ? `
          <div class="detail-section">
            <h3>Descrizione</h3>
            <p>${escapeHtml(data.descrizione)}</p>
          </div>
          ` : ''}

          ${data.preparazione ? `
          <div class="detail-section">
            <h3>Preparazione</h3>
            <p>${escapeHtml(data.preparazione)}</p>
          </div>
          ` : ''}

          ${data.esecuzione ? `
          <div class="detail-section">
            <h3>Esecuzione</h3>
            <p>${escapeHtml(data.esecuzione)}</p>
          </div>
          ` : ''}
          
          ${data.consiglietti ? `
          <div class="detail-section">
            <h3>Consiglietti</h3>
            <p>${escapeHtml(data.consiglietti)}</p>
          </div>
          ` : ''}
          
          ${data.variazioni ? `
          <div class="detail-section">
            <h3>Variazioni</h3>
            <p>${escapeHtml(data.variazioni)}</p>
          </div>
          ` : ''}
        </div>
      `
    }
    
    /* ==========================
      INIT
    ========================== */
    const ricettaId = getRicettaIdFromUrl()
    loadRicettaDetail(ricettaId)
  </script>
</body>
</html>