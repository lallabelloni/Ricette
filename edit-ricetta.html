<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Modifica Ricetta</title>
  <link rel="stylesheet" href="style-edit-ricetta.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <a href="edit.html" class="back-btn">‚Üê Torna alla lista admin</a>
  
  <div id="container" class="loading">Caricamento...</div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    const supabaseUrl = 'https://uummgynzxypcscvqtihf.supabase.co'
    // special key
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bW1neW56eHlwY3NjdnF0aWhmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzEyMTY4MCwiZXhwIjoyMDgyNjk3NjgwfQ._aMNw1Ysu5V3IgzMV2k7E-wMi7beulBzKhbj-QZYszM'
    const supabase = createClient(supabaseUrl, supabaseKey)
    const container = document.getElementById('container')
    
    let isEditMode = false
    let ricettaId = null
    
    // Liste globali
    let allIngredienti = []
    let allStagioni = []
    let allCategorie = []
    
    // Liste correnti della ricetta
    let currentIngredienti = []
    let currentStagioni = []
    let currentCategorie = []
    
    /* ==========================
      RECUPERA ID DALLA URL
    ========================== */
    function getRicettaIdFromUrl() {
      const params = new URLSearchParams(window.location.search)
      return params.get('id')
    }
    
    /* ==========================
      CARICA TUTTI GLI INGREDIENTI
    ========================== */
    async function loadAllIngredienti() {
      const { data, error } = await supabase
        .from('ingredienti')
        .select('id, nome')
        .order('nome')
      
      if (error) {
        console.error('Errore caricamento ingredienti:', error)
        return []
      }
      return data || []
    }
    
    /* ==========================
      CARICA TUTTE LE STAGIONI
    ========================== */
    async function loadAllStagioni() {
      const { data, error } = await supabase
        .from('stagioni')
        .select('id, nome')
        .order('nome')
      
      if (error) {
        console.error('Errore caricamento stagioni:', error)
        return []
      }
      return data || []
    }
    
    /* ==========================
      CARICA TUTTE LE CATEGORIE
    ========================== */
    async function loadAllCategorie() {
      const { data, error } = await supabase
        .from('categorie')
        .select('id, nome')
        .order('nome')
      
      if (error) {
        console.error('Errore caricamento categorie:', error)
        return []
      }
      return data || []
    }
    
    /* ==========================
      CARICA INGREDIENTI DELLA RICETTA
    ========================== */
    async function loadRicettaIngredienti(ricettaId) {
      const { data, error } = await supabase
        .from('ricetta_ingredienti')
        .select('id, quantita, id_ingredienti')
        .eq('id_ricetta', ricettaId)
      
      if (error) {
        console.error('Errore caricamento ingredienti ricetta:', error)
        return []
      }
      
      // Aggiungi i nomi dagli ingredienti globali
      return (data || []).map(item => {
        const ingrediente = allIngredienti.find(i => i.id === item.id_ingredienti)
        return {
          ...item,
          ingredienti: { nome: ingrediente?.nome || 'Sconosciuto' }
        }
      })
    }
    
    /* ==========================
      CARICA STAGIONI DELLA RICETTA
    ========================== */
    async function loadRicettaStagioni(ricettaId) {
      const { data, error } = await supabase
        .from('ricetta_stagioni')
        .select('id, id_stagioni')
        .eq('id_ricetta', ricettaId)
      
      if (error) {
        console.error('Errore caricamento stagioni ricetta:', error)
        return []
      }
      
      // Aggiungi i nomi dalle stagioni globali
      return (data || []).map(item => {
        const stagione = allStagioni.find(s => s.id === item.id_stagioni)
        return {
          ...item,
          stagioni: { nome: stagione?.nome || 'Sconosciuta' }
        }
      })
    }
    
    /* ==========================
      CARICA CATEGORIE DELLA RICETTA
    ========================== */
    async function loadRicettaCategorie(ricettaId) {
      const { data, error } = await supabase
        .from('ricetta_categorie')
        .select('id, id_categorie')
        .eq('id_ricetta', ricettaId)
      
      if (error) {
        console.error('Errore caricamento categorie ricetta:', error)
        return []
      }
      
      // Aggiungi i nomi dalle categorie globali
      return (data || []).map(item => {
        const categoria = allCategorie.find(c => c.id === item.id_categorie)
        return {
          ...item,
          categorie: { nome: categoria?.nome || 'Sconosciuta' }
        }
      })
    }
    
    /* ==========================
      RENDER INGREDIENTI
    ========================== */
    function renderIngredienti() {
      const container = document.getElementById('ingredientiList')
      
      container.innerHTML = currentIngredienti.map(ing => `
        <div class="tag-item" data-id="${ing.id}">
          <span>${escapeHtml(ing.ingredienti.nome)}${ing.quantita ? ', ' + escapeHtml(ing.quantita) : ''}</span>
          <button type="button" class="remove-btn" onclick="removeIngrediente(${ing.id})">‚úï</button>
        </div>
      `).join('')
    }
    
    /* ==========================
      RENDER STAGIONI
    ========================== */
    function renderStagioni() {
      const container = document.getElementById('stagioniList')
      
      container.innerHTML = currentStagioni.map(stag => `
        <div class="tag-item" data-id="${stag.id}">
          <span>${escapeHtml(stag.stagioni.nome)}</span>
          <button type="button" class="remove-btn" onclick="removeStagione(${stag.id})">‚úï</button>
        </div>
      `).join('')
    }
    
    /* ==========================
      RENDER CATEGORIE
    ========================== */
    function renderCategorie() {
      const container = document.getElementById('categorieList')
      
      container.innerHTML = currentCategorie.map(cat => `
        <div class="tag-item" data-id="${cat.id}">
          <span>${escapeHtml(cat.categorie.nome)}</span>
          <button type="button" class="remove-btn" onclick="removeCategoria(${cat.id})">‚úï</button>
        </div>
      `).join('')
    }
    
    /* ==========================
      AGGIUNGI INGREDIENTE
    ========================== */
    window.addIngrediente = async function() {
      const selectEl = document.getElementById('selectIngrediente')
      const quantitaEl = document.getElementById('quantitaIngrediente')
      const ingredienteId = parseInt(selectEl.value)
      const quantita = quantitaEl.value.trim()
      
      if (!ingredienteId) {
        alert('Seleziona un ingrediente')
        return
      }
      
      if (!ricettaId) {
        alert('Salva prima la ricetta')
        return
      }
      
      // Inserisci nel database
      const { data, error } = await supabase
        .from('ricetta_ingredienti')
        .insert([{
          id_ricetta: ricettaId,
          id_ingredienti: ingredienteId,
          quantita: quantita || null
        }])
        .select()
      
      if (error) {
        console.error('Errore aggiunta ingrediente:', error)
        alert('Errore durante l\'aggiunta')
        return
      }
      
      // Trova il nome dell'ingrediente dalla lista globale
      const ingrediente = allIngredienti.find(i => i.id === ingredienteId)
      
      // Aggiungi alla lista corrente con il nome
      currentIngredienti.push({
        id: data[0].id,
        quantita: data[0].quantita,
        id_ingredienti: ingredienteId,
        ingredienti: { nome: ingrediente.nome }
      })
      renderIngredienti()
      
      // Reset form
      selectEl.value = ''
      quantitaEl.value = ''
    }
    
    /* ==========================
      RIMUOVI INGREDIENTE
    ========================== */
    window.removeIngrediente = async function(id) {
      const { error } = await supabase
        .from('ricetta_ingredienti')
        .delete()
        .eq('id', id)
      
      if (error) {
        console.error('Errore rimozione ingrediente:', error)
        alert('Errore durante la rimozione')
        return
      }
      
      currentIngredienti = currentIngredienti.filter(i => i.id !== id)
      renderIngredienti()
    }
    
    /* ==========================
      AGGIUNGI STAGIONE
    ========================== */
    window.addStagione = async function() {
      const selectEl = document.getElementById('selectStagione')
      const stagioneId = parseInt(selectEl.value)
      
      if (!stagioneId) {
        alert('Seleziona una stagione')
        return
      }
      
      if (!ricettaId) {
        alert('Salva prima la ricetta')
        return
      }
      
      // Inserisci nel database
      const { data, error } = await supabase
        .from('ricetta_stagioni')
        .insert([{
          id_ricetta: ricettaId,
          id_stagioni: stagioneId
        }])
        .select()
      
      if (error) {
        console.error('Errore aggiunta stagione:', error)
        alert('Errore durante l\'aggiunta')
        return
      }
      
      // Trova il nome della stagione dalla lista globale
      const stagione = allStagioni.find(s => s.id === stagioneId)
      
      // Aggiungi alla lista corrente con il nome
      currentStagioni.push({
        id: data[0].id,
        id_stagioni: stagioneId,
        stagioni: { nome: stagione.nome }
      })
      renderStagioni()
      
      // Reset form
      selectEl.value = ''
    }
    
    /* ==========================
      RIMUOVI STAGIONE
    ========================== */
    window.removeStagione = async function(id) {
      const { error } = await supabase
        .from('ricetta_stagioni')
        .delete()
        .eq('id', id)
      
      if (error) {
        console.error('Errore rimozione stagione:', error)
        alert('Errore durante la rimozione')
        return
      }
      
      currentStagioni = currentStagioni.filter(s => s.id !== id)
      renderStagioni()
    }
    
    /* ==========================
      AGGIUNGI CATEGORIA
    ========================== */
    window.addCategoria = async function() {
      const selectEl = document.getElementById('selectCategoria')
      const categoriaId = parseInt(selectEl.value)
      
      if (!categoriaId) {
        alert('Seleziona una categoria')
        return
      }
      
      if (!ricettaId) {
        alert('Salva prima la ricetta')
        return
      }
      
      // Inserisci nel database
      const { data, error } = await supabase
        .from('ricetta_categorie')
        .insert([{
          id_ricetta: ricettaId,
          id_categorie: categoriaId
        }])
        .select()
      
      if (error) {
        console.error('Errore aggiunta categoria:', error)
        alert('Errore durante l\'aggiunta')
        return
      }
      
      // Trova il nome della categoria dalla lista globale
      const categoria = allCategorie.find(c => c.id === categoriaId)
      
      // Aggiungi alla lista corrente con il nome
      currentCategorie.push({
        id: data[0].id,
        id_categorie: categoriaId,
        categorie: { nome: categoria.nome }
      })
      renderCategorie()
      
      // Reset form
      selectEl.value = ''
    }
    
    /* ==========================
      RIMUOVI CATEGORIA
    ========================== */
    window.removeCategoria = async function(id) {
      const { error } = await supabase
        .from('ricetta_categorie')
        .delete()
        .eq('id', id)
      
      if (error) {
        console.error('Errore rimozione categoria:', error)
        alert('Errore durante la rimozione')
        return
      }
      
      currentCategorie = currentCategorie.filter(c => c.id !== id)
      renderCategorie()
    }
    
    /* ==========================
      CREA NUOVO INGREDIENTE
    ========================== */
    window.createNuovoIngrediente = async function() {
      const inputEl = document.getElementById('nuovoIngrediente')
      const nome = inputEl.value.trim()
      
      if (!nome) {
        alert('Inserisci il nome dell\'ingrediente')
        return
      }
      
      // Inserisci nella tabella ingredienti
      const { data, error } = await supabase
        .from('ingredienti')
        .insert([{ nome: nome }])
        .select()
      
      if (error) {
        console.error('Errore creazione ingrediente:', error)
        alert('Errore durante la creazione')
        return
      }
      
      // Aggiungi alla lista globale
      allIngredienti.push(data[0])
      allIngredienti.sort((a, b) => a.nome.localeCompare(b.nome))
      
      // Aggiorna la select
      const selectEl = document.getElementById('selectIngrediente')
      selectEl.innerHTML = '<option value="">-- Seleziona ingrediente --</option>' + 
        allIngredienti.map(ing => `<option value="${ing.id}">${escapeHtml(ing.nome)}</option>`).join('')
      
      // Seleziona il nuovo ingrediente
      selectEl.value = data[0].id
      
      // Reset input
      inputEl.value = ''
      
      alert(`‚úÖ Ingrediente "${nome}" creato con successo!`)
    }
    
    /* ==========================
      CREA NUOVA STAGIONE
    ========================== */
    window.createNuovaStagione = async function() {
      const inputEl = document.getElementById('nuovaStagione')
      const nome = inputEl.value.trim()
      
      if (!nome) {
        alert('Inserisci il nome della stagione')
        return
      }
      
      // Inserisci nella tabella stagioni
      const { data, error } = await supabase
        .from('stagioni')
        .insert([{ nome: nome }])
        .select()
      
      if (error) {
        console.error('Errore creazione stagione:', error)
        alert('Errore durante la creazione')
        return
      }
      
      // Aggiungi alla lista globale
      allStagioni.push(data[0])
      allStagioni.sort((a, b) => a.nome.localeCompare(b.nome))
      
      // Aggiorna la select
      const selectEl = document.getElementById('selectStagione')
      selectEl.innerHTML = '<option value="">-- Seleziona stagione --</option>' + 
        allStagioni.map(stag => `<option value="${stag.id}">${escapeHtml(stag.nome)}</option>`).join('')
      
      // Seleziona la nuova stagione
      selectEl.value = data[0].id
      
      // Reset input
      inputEl.value = ''
      
      alert(`‚úÖ Stagione "${nome}" creata con successo!`)
    }
    
    /* ==========================
      CREA NUOVA CATEGORIA
    ========================== */
    window.createNuovaCategoria = async function() {
      const inputEl = document.getElementById('nuovaCategoria')
      const nome = inputEl.value.trim()
      
      if (!nome) {
        alert('Inserisci il nome della categoria')
        return
      }
      
      // Inserisci nella tabella categorie
      const { data, error } = await supabase
        .from('categorie')
        .insert([{ nome: nome }])
        .select()
      
      if (error) {
        console.error('Errore creazione categoria:', error)
        alert('Errore durante la creazione')
        return
      }
      
      // Aggiungi alla lista globale
      allCategorie.push(data[0])
      allCategorie.sort((a, b) => a.nome.localeCompare(b.nome))
      
      // Aggiorna la select
      const selectEl = document.getElementById('selectCategoria')
      selectEl.innerHTML = '<option value="">-- Seleziona categoria --</option>' + 
        allCategorie.map(cat => `<option value="${cat.id}">${escapeHtml(cat.nome)}</option>`).join('')
      
      // Seleziona la nuova categoria
      selectEl.value = data[0].id
      
      // Reset input
      inputEl.value = ''
      
      alert(`‚úÖ Categoria "${nome}" creata con successo!`)
    }
    
    /* ==========================
      ESCAPE HTML
    ========================== */
    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }
    
    /* ==========================
      RENDER FORM
    ========================== */
    async function renderForm(data = null) {
      isEditMode = !!data
      ricettaId = data?.id || null
      
      // Se in edit mode, carica ingredienti/stagioni/categorie
      if (isEditMode) {
        [currentIngredienti, currentStagioni, currentCategorie] = await Promise.all([
          loadRicettaIngredienti(ricettaId),
          loadRicettaStagioni(ricettaId),
          loadRicettaCategorie(ricettaId)
        ])
      }
      
      container.innerHTML = `
        <div class="container">
          <h1>${isEditMode ? 'Modifica Ricetta' : 'Nuova Ricetta'}</h1>
          
          <div id="message"></div>
          
          <form id="ricettaForm">
            <div class="form-group">
              <label for="nome">Nome Ricetta *</label>
              <input type="text" id="nome" required value="${data?.nome || ''}">
            </div>
            
            <div class="form-group">
              <label for="fonte">Fonte</label>
              <input type="text" id="fonte" value="${data?.fonte || ''}">
            </div>
            
            <div class="form-group">
              <label for="costo">Costo (1-5) *</label>
              <input type="number" id="costo" min="1" max="5" required value="${data?.costo || 3}">
            </div>
            
            <div class="form-group">
              <label for="gusto">Gusto (1-5) *</label>
              <input type="number" id="gusto" min="1" max="5" required value="${data?.gusto || 3}">
            </div>
            
            <div class="form-group">
              <label for="sbatti">Sbattimento (1-5) *</label>
              <input type="number" id="sbatti" min="1" max="5" required value="${data?.sbatti || 3}">
            </div>

            ${data?.punteggio ? `
            <div class="form-group">
              <label>Punteggio (calcolato automaticamente)</label>
              <input type="text" value="‚≠ê ${Number(data.punteggio).toFixed(1)}" disabled style="background: #f0f0f0;">
            </div>
            ` : ''}

            <div class="form-group">
              <label for="descrizione">Descrizione</label>
              <textarea id="descrizione">${data?.descrizione || ''}</textarea>
            </div>

            <div class="form-group">
              <label for="preparazione">Preparazione</label>
              <textarea id="preparazione">${data?.preparazione || ''}</textarea>
            </div>

            <div class="form-group">
              <label for="esecuzione">Esecuzione</label>
              <textarea id="esecuzione">${data?.esecuzione || ''}</textarea>
            </div>
            
            <div class="form-group">
              <label for="consiglietti">Consiglietti</label>
              <textarea id="consiglietti">${data?.consiglietti || ''}</textarea>
            </div>
            
            <div class="form-group">
              <label for="variazioni">Variazioni</label>
              <textarea id="variazioni">${data?.variazioni || ''}</textarea>
            </div>
            
            ${isEditMode ? `
            <!-- SEZIONE INGREDIENTI -->
            <div class="tags-section">
              <label class="section-label">Ingredienti:</label>
              <div id="ingredientiList" class="tags-list"></div>
              <div class="add-tag-row">
                <select id="selectIngrediente" class="tag-select">
                  <option value="">-- Seleziona ingrediente --</option>
                  ${allIngredienti.map(ing => `<option value="${ing.id}">${escapeHtml(ing.nome)}</option>`).join('')}
                </select>
                <input type="text" id="quantitaIngrediente" placeholder="Quantit√†" class="quantita-input">
                <button type="button" class="btn-add-tag" onclick="addIngrediente()">+ Aggiungi</button>
              </div>
              <div class="add-new-row">
                <input type="text" id="nuovoIngrediente" placeholder="Nuovo ingrediente..." class="new-item-input">
                <button type="button" class="btn-create-new" onclick="createNuovoIngrediente()">‚ûï Crea Nuovo</button>
              </div>
            </div>
            
            <!-- SEZIONE STAGIONI -->
            <div class="tags-section">
              <label class="section-label">Stagioni:</label>
              <div id="stagioniList" class="tags-list"></div>
              <div class="add-tag-row">
                <select id="selectStagione" class="tag-select">
                  <option value="">-- Seleziona stagione --</option>
                  ${allStagioni.map(stag => `<option value="${stag.id}">${escapeHtml(stag.nome)}</option>`).join('')}
                </select>
                <button type="button" class="btn-add-tag" onclick="addStagione()">+ Aggiungi</button>
              </div>
              <div class="add-new-row">
                <input type="text" id="nuovaStagione" placeholder="Nuova stagione..." class="new-item-input">
                <button type="button" class="btn-create-new" onclick="createNuovaStagione()">‚ûï Crea Nuovo</button>
              </div>
            </div>
            
            <!-- SEZIONE CATEGORIE -->
            <div class="tags-section">
              <label class="section-label">Categorie:</label>
              <div id="categorieList" class="tags-list"></div>
              <div class="add-tag-row">
                <select id="selectCategoria" class="tag-select">
                  <option value="">-- Seleziona categoria --</option>
                  ${allCategorie.map(cat => `<option value="${cat.id}">${escapeHtml(cat.nome)}</option>`).join('')}
                </select>
                <button type="button" class="btn-add-tag" onclick="addCategoria()">+ Aggiungi</button>
              </div>
              <div class="add-new-row">
                <input type="text" id="nuovaCategoria" placeholder="Nuova categoria..." class="new-item-input">
                <button type="button" class="btn-create-new" onclick="createNuovaCategoria()">‚ûï Crea Nuovo</button>
              </div>
            </div>
            ` : '<div class="info-box">üí° Salva prima la ricetta per aggiungere ingredienti, stagioni e categorie</div>'}
            
            <button type="submit" class="btn btn-primary">
              ${isEditMode ? 'üíæ Salva Modifiche' : '‚ûï Crea Ricetta'}
            </button>
            <a href="edit.html" class="btn btn-secondary">‚ùå Annulla</a>
          </form>
        </div>
      `
      
      // Render liste se in edit mode
      if (isEditMode) {
        renderIngredienti()
        renderStagioni()
        renderCategorie()
      }
      
      // Event listener per il form
      document.getElementById('ricettaForm').addEventListener('submit', handleSubmit)
    }
    
    /* ==========================
      CARICA RICETTA
    ========================== */
    async function loadRicetta(id) {
      const { data, error } = await supabase
        .from('ricetta')
        .select('*')
        .eq('id', id)
        .single()
      
      if (error) {
        console.error('Errore caricamento:', error)
        container.innerHTML = `
          <div class="container">
            <div class="error">Errore nel caricamento della ricetta</div>
            <a href="edit.html" class="btn btn-secondary">Torna alla lista</a>
          </div>
        `
        return
      }
      
      await renderForm(data)
    }
    
    /* ==========================
      SALVA RICETTA
    ========================== */
    async function handleSubmit(e) {
      e.preventDefault()
      
      const formData = {
        nome: document.getElementById('nome').value.trim(),
        fonte: document.getElementById('fonte').value.trim() || null,
        costo: parseInt(document.getElementById('costo').value),
        gusto: parseInt(document.getElementById('gusto').value),
        sbatti: parseInt(document.getElementById('sbatti').value),
        descrizione: document.getElementById('descrizione').value.trim() || null,
        preparazione: document.getElementById('preparazione').value.trim() || null,
        esecuzione: document.getElementById('esecuzione').value.trim() || null,
        consiglietti: document.getElementById('consiglietti').value.trim() || null,
        variazioni: document.getElementById('variazioni').value.trim() || null
      }
      
      const messageDiv = document.getElementById('message')
      
      if (isEditMode) {
        // UPDATE
        const { error } = await supabase
          .from('ricetta')
          .update(formData)
          .eq('id', ricettaId)
        
        if (error) {
          console.error('Errore aggiornamento:', error)
          messageDiv.innerHTML = '<div class="error">Errore durante il salvataggio</div>'
          return
        }
        
        messageDiv.innerHTML = '<div class="success">‚úÖ Ricetta aggiornata con successo!</div>'
        setTimeout(() => {
          window.location.href = 'edit.html'
        }, 1500)
        
      } else {
        // INSERT
        const { data, error } = await supabase
          .from('ricetta')
          .insert([formData])
          .select()
        
        if (error) {
          console.error('Errore inserimento:', error)
          messageDiv.innerHTML = '<div class="error">Errore durante la creazione</div>'
          return
        }
        
        messageDiv.innerHTML = '<div class="success">‚úÖ Ricetta creata! Puoi ora aggiungere ingredienti, stagioni e categorie modificandola.</div>'
        setTimeout(() => {
          window.location.href = `edit-ricetta.html?id=${data[0].id}`
        }, 2000)
      }
    }
    
    /* ==========================
      INIT
    ========================== */
    async function init() {
      // Carica tutte le liste
      [allIngredienti, allStagioni, allCategorie] = await Promise.all([
        loadAllIngredienti(),
        loadAllStagioni(),
        loadAllCategorie()
      ])
      
      const id = getRicettaIdFromUrl()
      if (id) {
        await loadRicetta(id)
      } else {
        await renderForm()
      }
    }
    
    init()
  </script>
</body>
</html>