<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>ricerca la ricetta!</title>
</head>
<body>

  <h1>ricerca la ricetta!</h1>

  <input
    type="text"
    id="searchInput"
    placeholder="Scrivi il nome della ricetta..."
  >
  <button id="searchBtn">Cerca</button>

  <div id="output">Caricamento...</div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    /* ==========================
       CONFIG SUPABASE
    ========================== */
    const supabaseUrl = 'https://uummgynzxypcscvqtihf.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bW1neW56eHlwY3NjdnF0aWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjE2ODAsImV4cCI6MjA4MjY5NzY4MH0.e0mQ1QZ2B86JsAuy24kIkt43-m6KQz_zj7oYIi8P6I8'
    const supabase = createClient(supabaseUrl, supabaseKey)

    /* ==========================
   RENDER LISTA
========================== */
function renderList(data) {
  resultsDiv.innerHTML = ''

  if (!data || data.length === 0) {
    resultsDiv.innerHTML = '<p>Nessun risultato</p>'
    return
  }

  // intestazione
  resultsDiv.innerHTML += `
    <div class="row header">
      <div>Nome</div>
      <div>Fonte</div>
      <div>Costo</div>
      <div>Gusto</div>
      <div>Sbatti</div>
      <div>Punteggio</div>
    </div>
  `

  data.forEach(r => {
    resultsDiv.innerHTML += `
      <div class="row">
        <div>${r.nome}</div>
        <div>${r.fonte ?? '-'}</div>
        <div>${r.costo}</div>
        <div>${r.gusto}</div>
        <div>${r.sbatti}</div>
        <div>${Number(r.punteggio).toFixed(2)}</div>
      </div>
    `
  })
}

/* ==========================
   CARICAMENTO DEFAULT
========================== */
async function loadAllRicette() {
  const { data, error } = await supabase
    .from('ricetta')
    .select('nome, fonte, costo, gusto, sbatti, punteggio')
    .order('punteggio', { ascending: false })

  if (error) {
    console.error(error)
    resultsDiv.innerHTML = '<p>Errore caricamento dati</p>'
    return
  }

  renderList(data)
}

/* ==========================
   RICERCA
========================== */
async function searchRicette() {
  const query = searchInput.value.trim()

  if (query === '') {
    loadAllRicette()
    return
  }

  const { data, error } = await supabase
    .from('ricetta')
    .select('nome, fonte, costo, gusto, sbatti, punteggio')
    .ilike('nome', `%${query}%`)
    .order('punteggio', { ascending: false })

  if (error) {
    console.error(error)
    resultsDiv.innerHTML = '<p>Errore ricerca</p>'
    return
  }

  renderList(data)
}
    
    document
      .getElementById('searchBtn')
      .addEventListener('click', searchRicette)

    document
      .getElementById('searchInput')
      .addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          searchRicette()
      }
      })
      /* ==========================
        INIT
      ========================== */
      loadAllRicette()
  </script>

</body>
</html>

