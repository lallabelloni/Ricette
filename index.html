<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>ricerca la ricetta!</title>
</head>
<body>

  <h1>ricerca la ricetta!</h1>

  <input type="text" id="searchInput" placeholder="Scrivi il nome della ricetta...">
  <button id="searchBtn">Cerca</button>

  <button id="filterToggle">Filtri</button>

  <div id="filters" style="display:none; border:1px solid #ccc; padding:10px">

    <h3>Categorie</h3>
    <div id="categorie"></div>

    <h3>Stagioni</h3>
    <div id="stagioni"></div>

    <h3>Ingredienti</h3>
    <div id="ingredienti"></div>

    <button id="applyFilters">Applica filtri</button>
  </div>

  <div id="output">Caricamento...</div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    /* ==========================
       CONFIG SUPABASE
    ========================== */
    const supabaseUrl = 'https://uummgynzxypcscvqtihf.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bW1neW56eHlwY3NjdnF0aWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjE2ODAsImV4cCI6MjA4MjY5NzY4MH0.e0mQ1QZ2B86JsAuy24kIkt43-m6KQz_zj7oYIi8P6I8'
    const supabase = createClient(supabaseUrl, supabaseKey)
    const resultsDiv = document.getElementById('output')
    const searchInput = document.getElementById('searchInput')
    const searchBtn = document.getElementById('searchBtn')

    /* ==========================
      RENDER LISTA
    ========================== */
    function renderList(data) {
      resultsDiv.innerHTML = ''

      if (!data || data.length === 0) {
        resultsDiv.innerHTML = '<p>Nessun risultato</p>'
        return
      }

      // intestazione
      resultsDiv.innerHTML += `
        <div class="row header">
          Nome | Fonte | Costo | Gusto | Sbatti | Punteggio
        </div>
        /n
      `

      data.forEach(r => {
        resultsDiv.innerHTML += `
          <div>
            ${r.nome} | ${r.fonte ?? '-'} | costo: ${r.costo} | gusto: ${r.gusto} | sbatti: ${r.sbatti} | ⭐: ${Number(r.punteggio)}
          </div>
        `
      })
    }

    /* ==========================
      CARICAMENTO DEFAULT
    ========================== */
    async function loadAllRicette() {
      const { data, error } = await supabase
        .from('ricetta')
        .select('nome, fonte, costo, gusto, sbatti, punteggio')
        .order('punteggio', { ascending: false })

      if (error) {
        console.error(error)
        resultsDiv.innerHTML = '<p>Errore caricamento dati</p>'
        return
      }

      renderList(data)
    }

    /* ==========================
      RICERCA
    ========================== */
    async function searchAndFilter() {
    const query = searchInput.value.trim()

    // Prendi i filtri selezionati
    const categorieSelezionate = getCheckedIds('categorie')
    const stagioniSelezionate = getCheckedIds('stagioni')
    const ingredientiSelezionati = getCheckedIds('ingredienti')

    // Lista di array di ID di ricette da intersecare
    const idLists = []

    if (categorieSelezionate.length) {
      const ids = await getRicettaIds('ricetta_categorie', 'id_categoria', categorieSelezionate)
      if (ids.length === 0) { renderList([]); return } // nessuna ricetta corrisponde al filtro
      idLists.push(ids)
    }

    if (stagioniSelezionate.length) {
      const ids = await getRicettaIds('ricetta_stagioni', 'id_stagioni', stagioniSelezionate)
      if (ids.length === 0) { renderList([]); return }
      idLists.push(ids)
    }

    if (ingredientiSelezionati.length) {
      const ids = await getRicettaIds('ricetta_ingredienti', 'id_ingredienti', ingredientiSelezionati)
      if (ids.length === 0) { renderList([]); return }
      idLists.push(ids)
    }

    // Interseca tutti gli ID dei filtri selezionati
    const finalIds = idLists.length ? intersect(idLists) : null

    // Se ci sono filtri ma l'intersezione è vuota
    if (idLists.length && (!finalIds || finalIds.length === 0)) {
      renderList([])
      return
    }

    // Costruisci la query finale
    let queryBuilder = supabase
      .from('ricetta')
      .select('nome, fonte, costo, gusto, sbatti, punteggio')
      .order('punteggio', { ascending: false })

    if (finalIds) queryBuilder = queryBuilder.in('id', finalIds)
    if (query) queryBuilder = queryBuilder.ilike('nome', `%${query}%`)

    const { data, error } = await queryBuilder

    if (error) {
      console.error(error)
      resultsDiv.innerHTML = '<p>Errore caricamento</p>'
      return
    }

    renderList(data)
  }



    /* ==========================
      CARICAMENTO FILTRI
    ========================== */
    async function loadCheckbox(table, containerId) {
      const { data } = await supabase
        .from(table)
        .select('id, nome')
        .order('nome')

      const c = document.getElementById(containerId)
      data.forEach(e => {
        c.innerHTML += `
          <label>
            <input type="checkbox" value="${e.id}">
            ${e.nome}
          </label><br>
        `
      })
    }

    /* ==========================
      UTILS FILTRI
    ========================== */
    function getCheckedIds(id) {
      return [...document.querySelectorAll(`#${id} input:checked`)]
        .map(cb => cb.value)
    }

    function intersect(arrays) {
      return arrays.reduce((a, b) => a.filter(x => b.includes(x)))
    }

    /* ==========================
      QUERY TABELLE PONTE
    ========================== */
    async function getRicettaIds(table, column, ids) {
      if (ids.length === 0) return null

      const { data } = await supabase
        .from(table)
        .select('id_ricetta')
        .in(column, ids)

      return data.map(r => r.id_ricetta)
    }

    

    /* ==========================
      EVENTI
    ========================== */

    // Evento ricerca
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault()    // previene il comportamento di default
        searchAndFilter()     // esegue la ricerca con filtri
      }
    })

    // Bottone ricerca
    searchBtn.addEventListener('click', searchAndFilter)

    // Bottone filtri: toggle senza interferire con focus
    document.getElementById('filterToggle').addEventListener('click', () => {
      const f = document.getElementById('filters')
      f.style.display = f.style.display === 'none' ? 'block' : 'none'
    })

      /* ==========================
        INIT
      ========================== */
      loadCheckbox('categorie', 'categorie')
      loadCheckbox('stagioni', 'stagioni')
      loadCheckbox('ingredienti', 'ingredienti')
      loadAllRicette()
  </script>

</body>
</html>

