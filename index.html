<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>ricerca la ricetta!</title>
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <h1>ricerca la ricetta!</h1>
  <input type="text" id="searchInput" placeholder="Scrivi il nome della ricetta...">
  <button id="searchBtn">Cerca</button>
  <button id="filterToggle">Filtri</button>
  <div id="filters">
    <h3>Categorie</h3>
    <div id="categorie"></div>
    <h3>Stagioni</h3>
    <div id="stagioni"></div>
    <h3>Ingredienti</h3>
    <div id="ingredienti"></div>
  </div>
  <div id="output">Caricamento...</div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    /* ==========================
       CONFIG SUPABASE
    ========================== */
    const supabaseUrl = 'https://uummgynzxypcscvqtihf.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bW1neW56eHlwY3NjdnF0aWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjE2ODAsImV4cCI6MjA4MjY5NzY4MH0.e0mQ1QZ2B86JsAuy24kIkt43-m6KQz_zj7oYIi8P6I8'
    const supabase = createClient(supabaseUrl, supabaseKey)
    const resultsDiv = document.getElementById('output')
    const searchInput = document.getElementById('searchInput')
    const searchBtn = document.getElementById('searchBtn')
    
    /* ==========================
      RENDER LISTA
    ========================== */
    function renderList(data) {
      resultsDiv.innerHTML = ''
      if (!data || data.length === 0) {
        resultsDiv.innerHTML = '<p>Nessun risultato</p>'
        return
      }
      <div class="row header grid">
        <span>Nome</span>
        <span>Fonte</span>
        <span>Costo</span>
        <span>Gusto</span>
        <span>Sbatti</span>
        <span>Punteggio</span>
      </div>

      /*
      resultsDiv.innerHTML += `
        <div class="row header">
          Nome | Fonte | Costo | Gusto | Sbatti | Punteggio
        </div>
      */

      /*data.forEach(r => {
        resultsDiv.innerHTML += `
          <div style="padding:5px; border-bottom:1px solid #eee">
            ${r.nome} | ${r.fonte ?? '-'} | costo: ${r.costo} | gusto: ${r.gusto} | sbatti: ${r.sbatti} | ⭐: ${Number(r.punteggio)}
          </div>
        `
      })*/
      data.forEach(r => {
        const div = document.createElement('div')
        div.className = 'ricetta-item'
        div.innerHTML = `
          <span>${r.nome}</span>
          <span>${r.fonte ?? '-'}</span>
          <span>${r.costo}</span>
          <span>${r.gusto}</span>
          <span>${r.sbatti}</span>
          <span>⭐ ${Number(r.punteggio)}</span>
        `

        // Quando clicchi, vai alla pagina dettaglio passando l'ID
        div.addEventListener('click', () => {
          window.location.href = `ricetta.html?id=${r.id}`
        })
        resultsDiv.appendChild(div)
      })
    }
    
    /* ==========================
      CARICAMENTO DEFAULT
    ========================== */
    async function loadAllRicette() {
      const { data, error } = await supabase
        .from('ricetta')
        .select('id, nome, fonte, costo, gusto, sbatti, punteggio')
        .order('punteggio', { ascending: false })
      if (error) {
        console.error(error)
        resultsDiv.innerHTML = '<p>Errore caricamento dati</p>'
        return
      }
      renderList(data)
    }
    
    /* ==========================
      UTILS FILTRI
    ========================== */
    function getCheckedIds(containerId) {
      const checkboxes = document.querySelectorAll('#' + containerId + ' input[type="checkbox"]:checked')
      return Array.from(checkboxes).map(cb => cb.value)
    }
    
    function intersect(arrays) {
      if (arrays.length === 0) return []
      return arrays.reduce((a, b) => a.filter(x => b.includes(x)))
    }
    
    /* ==========================
      QUERY TABELLE PONTE
    ========================== */
    async function getRicettaIds(table, column, ids) {
      if (ids.length === 0) return []
      const { data, error } = await supabase
        .from(table)
        .select('id_ricetta')
        .in(column, ids)
      
      if (error) {
        console.error('Errore getRicettaIds:', error)
        return []
      }
      
      return data ? data.map(r => r.id_ricetta) : []
    }
    
    /* ==========================
      RICERCA E FILTRI
    ========================== */
    async function searchAndFilter() {
      console.log('Esecuzione searchAndFilter...')
      const query = searchInput.value.trim()
      
      // Prendi i filtri selezionati
      const categorieSelezionate = getCheckedIds('categorie')
      const stagioniSelezionate = getCheckedIds('stagioni')
      const ingredientiSelezionati = getCheckedIds('ingredienti')
      
      console.log('Filtri selezionati:', {
        categorie: categorieSelezionate,
        stagioni: stagioniSelezionate,
        ingredienti: ingredientiSelezionati
      })
      
      // Lista di array di ID di ricette da intersecare
      const idLists = []
      
      if (categorieSelezionate.length > 0) {
        const ids = await getRicettaIds('ricetta-categorie', 'id_categorie', categorieSelezionate)
        console.log('IDs da categorie:', ids)
        if (ids.length === 0) { 
          renderList([])
          return 
        }
        idLists.push(ids)
      }
      
      if (stagioniSelezionate.length > 0) {
        const ids = await getRicettaIds('ricetta-stagioni', 'id_stagioni', stagioniSelezionate)
        console.log('IDs da stagioni:', ids)
        if (ids.length === 0) { 
          renderList([])
          return 
        }
        idLists.push(ids)
      }
      
      if (ingredientiSelezionati.length > 0) {
        const ids = await getRicettaIds('ricetta-ingredienti', 'id_ingredienti', ingredientiSelezionati)
        console.log('IDs da ingredienti:', ids)
        if (ids.length === 0) { 
          renderList([])
          return 
        }
        idLists.push(ids)
      }
      
      // Interseca tutti gli ID dei filtri selezionati
      const finalIds = idLists.length > 0 ? intersect(idLists) : null
      console.log('IDs finali dopo intersezione:', finalIds)
      
      // Se ci sono filtri ma l'intersezione è vuota
      if (idLists.length > 0 && (!finalIds || finalIds.length === 0)) {
        renderList([])
        return
      }
      
      // Costruisci la query finale
      let queryBuilder = supabase
        .from('ricetta')
        .select('id, nome, fonte, costo, gusto, sbatti, punteggio')
        .order('punteggio', { ascending: false })
      
      if (finalIds && finalIds.length > 0) {
        queryBuilder = queryBuilder.in('id', finalIds)
      }
      
      if (query) {
        queryBuilder = queryBuilder.ilike('nome', `%${query}%`)
      }
      
      const { data, error } = await queryBuilder
      
      if (error) {
        console.error(error)
        resultsDiv.innerHTML = '<p>Errore caricamento</p>'
        return
      }
      
      console.log('Risultati finali:', data)
      renderList(data)
    }
    
    /* ==========================
      CARICAMENTO FILTRI
    ========================== */
    async function loadCheckbox(table, containerId) {
      const { data, error } = await supabase
        .from(table)
        .select('id, nome')
        .order('nome')
      
      if (error) {
        console.error('Errore caricamento checkbox:', error)
        return
      }
      
      const container = document.getElementById(containerId)
      data.forEach(e => {
        const label = document.createElement('label')
        const checkbox = document.createElement('input')
        checkbox.type = 'checkbox'
        checkbox.value = e.id
        checkbox.addEventListener('change', searchAndFilter)
        
        label.appendChild(checkbox)
        label.appendChild(document.createTextNode(' ' + e.nome))
        container.appendChild(label)
      })
    }
    
    /* ==========================
      EVENTI
    ========================== */
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault()
        searchAndFilter()
      }
    })
    
    searchBtn.addEventListener('click', () => {
      console.log('Click su Cerca')
      searchAndFilter()
    })
    
    document.getElementById('filterToggle').addEventListener('click', () => {
      const f = document.getElementById('filters')
      f.style.display = f.style.display === 'none' ? 'block' : 'none'
    })
    
    /* ==========================
      INIT
    ========================== */
    async function init() {
      await loadCheckbox('categorie', 'categorie')
      await loadCheckbox('stagioni', 'stagioni')
      await loadCheckbox('ingredienti', 'ingredienti')
      await loadAllRicette()
      console.log('Inizializzazione completata')
    }
    
    init()
  </script>
</body>
</html>