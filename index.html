<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>ricerca la ricetta!</title>
</head>
<body>

  <h1>ricerca la ricetta!</h1>

  <input type="text" id="searchInput" placeholder="Scrivi il nome della ricetta...">
  <button id="searchBtn">Cerca</button>

  <button id="filterToggle">Filtri</button>

  <div id="filters" style="display:none; border:1px solid #ccc; padding:10px">

    <h3>Categorie</h3>
    <div id="categorie"></div>

    <h3>Stagioni</h3>
    <div id="stagioni"></div>

    <h3>Ingredienti</h3>
    <div id="ingredienti"></div>

    <button id="applyFilters">Applica filtri</button>
  </div>

  <div id="output">Caricamento...</div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    /* ==========================
       CONFIG SUPABASE
    ========================== */
    const supabaseUrl = 'https://uummgynzxypcscvqtihf.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bW1neW56eHlwY3NjdnF0aWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjE2ODAsImV4cCI6MjA4MjY5NzY4MH0.e0mQ1QZ2B86JsAuy24kIkt43-m6KQz_zj7oYIi8P6I8'
    const supabase = createClient(supabaseUrl, supabaseKey)
    const resultsDiv = document.getElementById('output')
    const searchInput = document.getElementById('searchInput')
    const searchBtn = document.getElementById('searchBtn')

    /* ==========================
      RENDER LISTA
    ========================== */
    function renderList(data) {
      resultsDiv.innerHTML = ''

      if (!data || data.length === 0) {
        resultsDiv.innerHTML = '<p>Nessun risultato</p>'
        return
      }

      // intestazione
      resultsDiv.innerHTML += `
        <div class="row header">
          <div>Nome</div><div>Fonte</div><div>Costo</div><div>Gusto</div><div>Sbatti</div><div>Punteggio</div>
        </div>
      `

      data.forEach(r => {
        resultsDiv.innerHTML += `
          <div>
            ${r.nome} | ${r.fonte ?? '-'} | costo: ${r.costo} | gusto: ${r.gusto} | sbatti: ${r.sbatti} | ‚≠ê: ${Number(r.punteggio)}
          </div>
        `
      })
    }

    /* ==========================
      CARICAMENTO DEFAULT
    ========================== */
    async function loadAllRicette() {
      const { data, error } = await supabase
        .from('ricetta')
        .select('nome, fonte, costo, gusto, sbatti, punteggio')
        .order('punteggio', { ascending: false })

      if (error) {
        console.error(error)
        resultsDiv.innerHTML = '<p>Errore caricamento dati</p>'
        return
      }

      renderList(data)
    }

    /* ==========================
      RICERCA
    ========================== */
    async function searchRicette() {
      const query = searchInput.value.trim()

      if (query === '') {
        loadAllRicette()
        return
      }

      const { data, error } = await supabase
        .from('ricetta')
        .select('nome, fonte, costo, gusto, sbatti, punteggio')
        .ilike('nome', `%${query}%`)
        .order('punteggio', { ascending: false })

      if (error) {
        console.error(error)
        resultsDiv.innerHTML = '<p>Errore ricerca</p>'
        return
      }

      renderList(data)
    }

    /* ==========================
      CARICAMENTO FILTRI
    ========================== */
    async function loadCheckbox(table, containerId) {
      const { data } = await supabase
        .from(table)
        .select('id, nome')
        .order('nome')

      const c = document.getElementById(containerId)
      data.forEach(e => {
        c.innerHTML += `
          <label>
            <input type="checkbox" value="${e.id}">
            ${e.nome}
          </label><br>
        `
      })
    }

    /* ==========================
      UTILS FILTRI
    ========================== */
    function getCheckedIds(id) {
      return [...document.querySelectorAll(`#${id} input:checked`)]
        .map(cb => cb.value)
    }

    function intersect(arrays) {
      return arrays.reduce((a, b) => a.filter(x => b.includes(x)))
    }

    /* ==========================
      QUERY TABELLE PONTE
    ========================== */
    async function getRicettaIds(table, column, ids) {
      if (ids.length === 0) return null

      const { data } = await supabase
        .from(table)
        .select('ricetta_id')
        .in(column, ids)

      return data.map(r => r.ricetta_id)
    }

    /* ==========================
      APPLICA FILTRI
    ========================== */
    async function applyFilters() {
      const c = getCheckedIds('categorie')
      const s = getCheckedIds('stagioni')
      const i = getCheckedIds('ingredienti')

      const lists = []

      if (c.length) lists.push(await getRicettaIds('ricetta_categorie', 'categoria_id', c))
      if (s.length) lists.push(await getRicettaIds('ricetta_stagioni', 'stagione_id', s))
      if (i.length) lists.push(await getRicettaIds('ricetta_ingredienti', 'ingrediente_id', i))

      if (lists.length === 0) {
        loadAllRicette()
        return
      }

      const ids = intersect(lists)
      if (ids.length === 0) {
        renderList([])
        return
      }

      const { data } = await supabase
        .from('ricetta')
        .select('nome, fonte, costo, gusto, sbatti, punteggio')
        .in('id', ids)

      renderList(data)
    }

    /* ==========================
      EVENTI
    ========================== */

    document.getElementById('searchBtn').onclick = searchRicette

    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault()
        searchRicette()
      }
    })

    document.getElementById('applyFilters').onclick = applyFilters

    document.getElementById('filterToggle').onclick = () => {
      const f = document.getElementById('filters')
      f.style.display = f.style.display === 'none' ? 'block' : 'none'
    }


      /* ==========================
        INIT
      ========================== */
      loadCheckbox('categorie', 'categorie')
      loadCheckbox('stagioni', 'stagioni')
      loadCheckbox('ingredienti', 'ingredienti')
      loadAllRicette()
  </script>

</body>
</html>

