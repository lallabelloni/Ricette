<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Ricerca ricette</title>
  
</head>
<body>

  <h1>Cerca ricette</h1>

  <!-- INGREDIENTI -->
  <section>
    <h2>Ingredienti principali</h2>
    <div id="ingredienti"></div>
    <button id="searchBtn">Cerca ricette</button>
  </section>

  <!-- RISULTATI -->
  <section>
    <h2>Risultati</h2>
    <div id="results"></div>
  </section>

  <!-- SCRIPT -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    /* ==========================
       CONFIGURAZIONE SUPABASE
    ========================== */
    const supabaseUrl = 'https://uummgynzxypcscvqtihf.supabase.co
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bW1neW56eHlwY3NjdnF0aWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjE2ODAsImV4cCI6MjA4MjY5NzY4MH0.e0mQ1QZ2B86JsAuy24kIkt43-m6KQz_zj7oYIi8P6I8'
    const supabase = createClient(supabaseUrl, supabaseKey)

    /* ==========================
       CARICA INGREDIENTI
    ========================== */
    async function loadIngredienti() {
      const { data, error } = await supabase
        .from('ingredienti')
        .select('*')
        .order('nome')

      if (error) {
        console.error(error)
        return
      }

      const container = document.getElementById('ingredienti')

      data.forEach(ing => {
        const label = document.createElement('label')
        label.innerHTML = `
          <input type="checkbox" value="${ing.id}">
          ${ing.nome}
        `
        container.appendChild(label)
      })
    }

    loadIngredienti()

    /* ==========================
       INGREDIENTI SELEZIONATI
    ========================== */
    function getSelectedIngredienti() {
      return Array.from(
        document.querySelectorAll('#ingredienti input:checked')
      ).map(cb => cb.value)
    }

    /* ==========================
       QUERY DI RICERCA
    ========================== */
    async function searchRicette() {
      const ingredientIds = getSelectedIngredienti()

      if (ingredientIds.length === 0) {
        alert('Seleziona almeno un ingrediente')
        return
      }

      const { data, error } = await supabase
        .from('ricette_ingredienti')
        .select(`
          ricetta_id,
          ricette (
            id,
            titolo,
            immagine_url
          )
        `)
        .in('ingrediente_id', ingredientIds)
        .eq('principale', true)

      if (error) {
        console.error(error)
        return
      }

      /* ==========================
         LOGICA: ricette che
         contengono TUTTI gli ingredienti
      ========================== */
      const countMap = {}

      data.forEach(row => {
        countMap[row.ricetta_id] =
          (countMap[row.ricetta_id] || 0) + 1
      })

      const ricetteValide = Object.entries(countMap)
        .filter(([_, count]) => count === ingredientIds.length)
        .map(([id]) => id)

      const risultati = data.filter(row =>
        ricetteValide.includes(row.ricetta_id)
      )

      renderResults(risultati)
    }

    /* ==========================
       MOSTRA RISULTATI
    ========================== */
    function renderResults(data) {
      const container = document.getElementById('results')
      container.innerHTML = ''

      if (data.length === 0) {
        container.innerHTML = '<p>Nessuna ricetta trovata</p>'
        return
      }

      data.forEach(row => {
        const r = row.ricette
        const article = document.createElement('article')

        article.innerHTML = `
          <h3>${r.titolo}</h3>
          ${r.immagine_url ? `<img src="${r.immagine_url}">` : ''}
          <a href="ricetta.html?id=${r.id}">Vedi ricetta</a>
        `

        container.appendChild(article)
      })
    }

    /* ==========================
       EVENTO BOTTONE
    ========================== */
    document
      .getElementById('searchBtn')
      .addEventListener('click', searchRicette)

  </script>
</body>
</html>
